#
# Kbuild for top-level directory of the kernel
# This file takes care of the following:
# 1) Generate asm-offsets.h

#####
# 1) Generate asm-offsets.h
#

offsets-file := asm-offsets.h

CONFIG_GEN_ASCII ?= 1

CROSS_COMPILE := arm-none-eabi-
CC := $(CROSS_COMPILE)gcc
RM := rm -rf

#CFLAGS += -m32

# Default sed regexp - multiline due to syntax constraints
ifeq ($(CONFIG_GEN_ASCII),1)
# Use [:space:] because LLVM's integrated assembler inserts <tab> around
# the .ascii directive whereas GCC keeps the <space> as-is.
define sed-offsets
	's:^[[:space:]]*\.ascii[[:space:]]*"\(.*\)".*:\1:; \
	/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}'
endef
else
#define sed-offsets
#	"/^->/{s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:->::; p;}"
#endef

define sed-offsets
	"/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}"
endef
endif

define filechk_offsets
	(set -e; \
	 echo "#ifndef $1"; \
	 echo "#define $1"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was generated by Kbuild"; \
	 echo " *"; \
	 echo " */"; \
	 echo ""; \
	 sed -ne $(sed-offsets) $<; \
	 echo ""; \
	 echo "#endif" ) >$@
endef

define config_gen
	(set -e; \
	 echo "#ifndef __CONFIG_H"; \
	 echo "#define __CONFIG_H"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was auto generated."; \
	 echo " *"; \
	 echo " */"; \
	 echo ""; \
	 echo "#define CONFIG_GEN_ASCII $(CONFIG_GEN_ASCII)"; \
	 echo ""; \
	 echo "#endif" ) >$@
endef

.PHONY: all clean
all: config.h $(offsets-file)

config.h:
	@$(call config_gen)

# We use internal kbuild rules to avoid the "is up to date" message from make
asm-offsets.s: asm-offsets.c
	@$(CC) $(CFLAGS) -S $<

$(offsets-file): asm-offsets.s
	@$(call filechk_offsets,__ASM_OFFSETS_H__)

clean:
	-$(RM) config.h asm-offsets.s $(offsets-file)

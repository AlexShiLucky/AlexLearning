#
# Kbuild for top-level directory of the kernel
# This file takes care of the following:
# 1) Generate asm-offsets.h

#####
# 1) Generate asm-offsets.h
#

offsets-file := asm-offsets.h

CONFIG_GEN_ASCII ?= 0

CROSS_COMPILE :=
CC := $(CROSS_COMPILE)gcc
RM := rm -rf

CFLAGS += -m32

# Default sed regexp - multiline due to syntax constraints
ifeq ($(CONFIG_GEN_ASCII),1)
define sed-y
	"s:[[:space:]]*\.ascii[[:space:]]*\"\(.*\)\":\1:; \
	/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([-0-9]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}"
endef
else
#define sed-y
#	"/^->/{s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; s:->::; p;}"
#endef

define sed-y
	"/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}"
endef
endif

define cmd_offsets
	(set -e; \
	 echo "#ifndef __ASM_OFFSETS_H__"; \
	 echo "#define __ASM_OFFSETS_H__"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was generated by Kbuild"; \
	 echo " *"; \
	 echo " */"; \
	 echo ""; \
	 sed -ne $(sed-y) $<; \
	 echo ""; \
	 echo "#endif" ) > $@
endef

define config_gen
	(set -e; \
	 echo "#ifndef __CONFIG_H"; \
	 echo "#define __CONFIG_H"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was auto generated."; \
	 echo " *"; \
	 echo " */"; \
	 echo ""; \
	 echo "#define CONFIG_GEN_ASCII $(CONFIG_GEN_ASCII)"; \
	 echo ""; \
	 echo "#endif" ) >$@
endef

.PHONY: all clean
all: config.h $(offsets-file)

config.h:
	@$(call config_gen)

# We use internal kbuild rules to avoid the "is up to date" message from make
asm-offsets.s: asm-offsets.c
	@$(CC) $(CFLAGS) -S $<

$(offsets-file): asm-offsets.s
	@$(cmd_offsets)

clean:
	-$(RM) config.h asm-offsets.s $(offsets-file)

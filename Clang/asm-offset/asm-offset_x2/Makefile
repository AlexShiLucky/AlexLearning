#
# Kbuild for top-level directory of the kernel
# This file takes care of the following:
# 1) Generate asm-offsets.h

#####
# 1) Generate asm-offsets.h
#

offsets-file := asm-offsets.h

CROSS_COMPILE := arm-none-eabi-
CC := $(CROSS_COMPILE)gcc
RM := rm -rf

#CFLAGS += -m32

# Default sed regexp - multiline due to syntax constraints
define sed-y
	"/^->/{s:->#\(.*\):/* \1 */:; \
	s:^->\([^ ]*\) [\$$#]*\([^ ]*\) \(.*\):#define \1 \2 /* \3 */:; \
	s:->::; p;}"
endef

define cmd_offsets
	(set -e; \
	 echo "#ifndef __ASM_OFFSETS_H__"; \
	 echo "#define __ASM_OFFSETS_H__"; \
	 echo "/*"; \
	 echo " * DO NOT MODIFY."; \
	 echo " *"; \
	 echo " * This file was generated by Kbuild"; \
	 echo " *"; \
	 echo " */"; \
	 echo ""; \
	 sed -ne $(sed-y) $<; \
	 echo ""; \
	 echo "#endif" ) > $@
endef

.PHONY: all clean
all: $(offsets-file)

# We use internal kbuild rules to avoid the "is up to date" message from make
asm-offsets.s: asm-offsets.c
	@$(CC) $(CFLAGS) -S $<

$(offsets-file): asm-offsets.s
	@$(cmd_offsets)

clean:
	-$(RM) asm-offsets.s $(offsets-file)
